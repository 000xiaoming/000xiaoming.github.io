<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <meta name="baidu-site-verification" content="codeva-OySZDT59RD" />
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-Y95F7Y9NT1"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-Y95F7Y9NT1');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?9b08ea589f23fb1f5e2be85b8ca26b60";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>


  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="v-vincen,v-vincen,livemylife,IT  blog,Blog"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/highlight.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/widget.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/rocket.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/signature.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/catalog.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/gitalk.css"/>
      <!-- gitalk end -->
    

  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://000xiaoming.github.io/cn/device_function_and_mechanism/">
  <title>
    
      外设功能函数/跟踪函数与机制分析 - I&#39;m Bruce Lee
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">经年治世</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">首页</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              关于
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archives/">
              
              归档
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              分类
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              标签
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>搜索</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <!-- CDN: jsdelivr start -->
  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/lml_bg1.png');
      --intro-header-background-image-url-page: url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io//img/header_img/lml_bg1.png');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/lml_bg1.png');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io//img/header_img/lml_bg1.png');
    }
    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/lml_bg1.png'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/vincent-white.png');
      }
    
  </style>
  <!-- CDN: jsdelivr end -->





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#项目工程" title="项目工程">项目工程</a>
              
            </div>
            <h1>外设功能函数/跟踪函数与机制分析</h1>
            <h2 class="subheading">项目工程</h2>
            <span class="meta">
              Posted by Bruce Lee on
              2024-09-01
            </span>


            
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h3 id="关于我">关于我</h3>
<p>欢迎来到我的博客！这里汇集了我对编程和技术的洞见和总结。本站内容分为几个主要类别，涵盖从具体技术实现到编程理念的广泛话题。</p>
<h4 id="主要内容分类">主要内容分类</h4>
<ul>
<li><strong>项目工程</strong>：深入探讨技术的实现细节和理解。</li>
<li><strong>C/C++</strong>：围绕C/C++语言的技术点和编程技巧进行详细总结。</li>
<li><strong>程序员哲学</strong>：分享程序员在职业生涯中应该具备的哲学理念和思考方式。</li>
</ul>
<p>想要了解更多具体内容，您可以访问<a href="https://000xiaoming.github.io/categories/">文章分类</a>页面。</p>
<h4 id="联系我">联系我</h4>
<p>如果您有任何问题或想要交流，欢迎通过<a href="https://000xiaoming.github.io/about/">关于页面</a>与我联系。</p>
<p>感谢您的阅读和支持，希望我的博客能为您的技术旅程带来帮助！</p>
<hr>
<h3 id="时钟">时钟</h3>
<p>关于实现__am_timer_uptime函数的时候,并没有机会去获得系统启动时间.</p>
<p>应该将__am_timer_init函数实现,并且声明一个全局的AM_TIMER_UPTIME变量用于存储启动时间.</p>
<p>RTC_ADDR地址处的8字节,是关于时间的信息.依次读取出来.</p>
<p>但是关于i8253计时器的模拟代码中,</p>
<p>关于offset偏移,应该要加上为0的时候,应该也要将端口刷新时间信息.</p>
<p>我们到读取时间信息的时候,是读RTC_ADDR地址的内容,这里的内容是rtc_io_handler函数在做维护.</p>
<p>这个函数被add_mmio_map调用.</p>
<p>其实这里的一系列的函数调用串,有一条是回到的paddr.c文件.</p>
<p>在paddr_write函数中,每一次的访寸,都会调用mmio_write函数</p>
<p>mmio_write函数应该是负责刷新外设接口信息的.</p>
<p>在目标缓存地址地方,都会被刷新信息.</p>
<p>模拟器的时间从根本上来说是调用gettime函数,进而调用get_time_internal函数,然后通过调用gettimeofday函数来获取.</p>
<p>然后模拟了时钟.</p>
<p>在monitor文件中,初始化了device,其中就有init_timer函数,调用了add_mmio_map函数进行获取第一次的时间信息.</p>
<p>在execute中,条件编译了device_update函数,用于每次的更新时钟端口.</p>
<p>在device.c文件中定义device_update函数,</p>
<h3 id="错误缘起">错误缘起</h3>
<p>在printf实现的附近,编译到native中,出现了segment fault.</p>
<p>经过gdb的观察,是内存的访问除了错误,重点在printf函数.</p>
<p>可能的原因是klib的实现,并不是严格的gnu标准.</p>
<p>此时,便无法通过运行在native中,来测试klib的正确性.</p>
<p>但是一直一来,都是可以运行在nemu上的.</p>
<p>在运行demo中的程序中,出现了错误,但是代码雨是正确的.</p>
<p>看了源码和开trace,应该是memmove等一系列函数我没有实现.</p>
<p>实现之后,还没有编写klib-test进行测试.</p>
<p>直接开始运行demo</p>
<p>还是错误.</p>
<p>重新理清一下逻辑,然后运行最后一个bf程序,打开ftrace.</p>
<p>观察了调用栈,然后再最后一句,关于malloc的调用上,发现了可疑的问题.</p>
<p>回看malloc代码.</p>
<p>回看bench的实现,发现了遗漏关于hbrk的初始化.</p>
<p>然后补上这个初始化.</p>
<p>这里及时补充的初始化是直接在malloc函数内部进行,过段时间,编写专用的init函数,放置在集成的初始化函数堆里.</p>
<p>然后现在demo全部运行正确.</p>
<h3 id="有趣的io-read宏">有趣的io_read宏</h3>
<p>在bench.c文件中,uptime函数是如何获取时间信息的.</p>
<p>其实是返回了调用io_read宏的结果.</p>
<p>io_read宏的使用方式是:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">io_read</span><span class="params">(AM_TIMER_UPTIME)</span></span>.us</span><br></pre></td></tr></table></figure>
<p>这种用法很少,感觉很有趣.其实这里只需要分析一下io_read的返回值是什么,就知道为何要引用us了.</p>
<p>从这个结构可以猜出,返回的是一个AM_TIMER_UPTIME_T类型变量,引用了内部的us变量.</p>
<p>这中间是怎么起作用的?</p>
<p>io_read的定义中,传入的参数会被 ## 粘结符连接上_T,然后定义了__io_param这个临时变量.</p>
<p>所以传入的AM_TIMER_UPTIME会被粘结成AM_TIMER_UPTIME_T,然后定义一个局部变量.</p>
<p>然后调用了ioe_read函数.</p>
<p>其实传入的AM_TIMER_UPTIME也是一个宏,代表数字4.</p>
<p>在调用ioe_read宏时,是直接返回了lut数组的AM_TIMER_UPTIME项,其实这个返回就是函数地址,然后传入buf,就是局部变量,那么返回了这个局部变量的值,这个值就是时间.</p>
<p>返回到io_read宏中,最后一句就是使用局部变量,返回的就是这个变量值.</p>
<h2 id="putch函数实现">putch函数实现</h2>
<p>putch函数是调用了outb函数</p>
<p>outb是直接访问了addr地址,将data写入.</p>
<p>这里在putch函数中调用的outb,传入的参数是串口的地址:SERIAL_PORT</p>
<h2 id="关于native和klib的隔离">关于native和klib的隔离</h2>
<p>之前分析的关于在native中运行一直出现段错误,然而在nemu中运行良好的问题.</p>
<p>主要就是自己实现的库和glibc中的标准库不是完美符合的.</p>
<p>在stdlib等几个文件头部,可以重新实现一下条件编译的__ISA_NATIVE__宏.</p>
<p>就可以在定义了__NATIVE_USE_KLIB宏定义的情况下,编译到native中依然是链接glibc中的库.</p>
<h2 id="dtrace实现原理">dtrace实现原理</h2>
<p>如果每一次访问device都记录一遍,那么将是一个无底洞.</p>
<p>所以,在连续的对一个device访问时,只记录一次该device,如果更换访问目标,则记录另一个.</p>
<p>并且dtrace记录到Log中包装的nemu-log中,所以dtrace依赖于itrace.</p>
<p>dtrace没有什么大的负担,不如就放入itrace一块,默认开启,并且不用定义DTRACE宏.</p>
<p>每一次的访问device,都是调用了mmio_read/write,这个函数单一调用map_read/write,在map_read/write中进行专门的处理.</p>
<p>所以dtrace代码应该在map_read/write中实现.</p>
<p>问题就是,记录到nemu-log中的访问设备信息,会被指令信息淹没.</p>
<p>所以,在开启dtrace的时候,最好是关闭掉itrace</p>
<p>为何要记录到nemu-log中?</p>
<p>因为要访问设备,大部分是要有输入输出,音频等,如果将访问记录也输出到屏幕中,会扰乱程序的展示效果.</p>
<p>临时,添加了DTRACE,依赖于TRACE</p>
<p>由于要记录device的访问记录,同时也不能输出,所以定义了一个新的宏:log_only,复用了log_write宏.</p>
<h2 id="关于键盘实现">关于键盘实现</h2>
<p>既然有了表示按下/抬起的keydown变量,那么另一个变量理应存储重要的键码,按下键码,而不是释放键码.</p>
<p>所以应该与0x00ffand一下.</p>
<h2 id="多个键同时按下">多个键同时按下</h2>
<p>在按下控制键的时候,保持状态,会输出关于这个键的键码和状态,然后按下其他键的时候,就知道功能键是在控制键为down的状态下按下的.</p>
<h2 id="VGA">VGA</h2>
<h3 id="关于AM-GPU-CONFIG控制器信息">关于AM_GPU_CONFIG控制器信息</h3>
<p>屏幕的大小信息的确定来自CONFIG_VGA_SIXE_800x600宏的定义.</p>
<p>如果定义了该宏,那么SCREEN_W/H就会是800或400/600或300.</p>
<p>别的地方获取屏幕大小信息,源头是调用了screen_width/height函数,其中有MUXDEF宏的选择性决定屏幕大小.一般而言,我们是定义了CONFIG_TARGET_AM宏,所以返回值一般就是我们的AM_GPU_CONFIG抽象寄存器中的内容.</p>
<p>综上,屏幕大小信息的来源是CONFIG寄存器.所以该寄存器的width和height的决定不可能是是调用别的地方的函数或者从内存中读取出来.</p>
<h4 id="总内存大小">总内存大小</h4>
<p>…</p>
<p>还有另一种信息来源,就是在nemu.h中,定义了RANGE宏,其中关于FB_ADDR的传入参数,有一些透露出,FB_ADDR内存的大小.</p>
<h3 id="关于AM-GPU-FBDRAW帧缓存控制器">关于AM_GPU_FBDRAW帧缓存控制器</h3>
<p>坐标,小矩形图像.</p>
<p>绘制算法,就是要按照小矩形图像来换行,早先编写代码,是直接线性填充,出现了色块变线条的bug.其实是填充算法的错误.</p>
<p>需要首先定位到FB_ADDR地址,然后定位到坐标地址.然后嵌套for循环,来填充颜色数据.</p>
<h3 id="在am中的访存">在am中的访存</h3>
<p>在am中,有多处是直接访问地址数值,例如上述的访问FB_ADDR,由于am也是跑在nemu中,而nemu是全系统模拟器,所以实际上即使代码是访问内存,其实也是被nemu给映射了.</p>
<h3 id="映射原理">映射原理</h3>
<h3 id="屏幕大小寄存器和同步寄存器">屏幕大小寄存器和同步寄存器</h3>
<p>硬件的实现,是已经vgactl_port_base申请了内存,向8对齐.申请了8字节.</p>
<p>其中首4字节的高位存储着宽,低位存储着长.</p>
<p>只需要读取vgactl_port_base的高32位,就可以读取出宽和长.</p>
<p>这里的寄存器的写入信息的来源,是前面的分析中体现出的源头.</p>
<p>同步寄存器,连着一块被申请了,因为在gpu.c中定义的SYNC_ADDR宏是定义在VGACTL_ADDR+4的基础上的.</p>
<h3 id="裸着的抽象寄存器">裸着的抽象寄存器</h3>
<p>并没有显而易见的定义这两个寄存器以及软件.</p>
<p>屏幕大小寄存器将信息写入了目标地址,但是在引用的时候,我嫌麻烦,并没有直接去访问这里的地址,而是一般直接从__am_gpu_config中读取.</p>
<p>同步寄存器.在一些填充完毕的色块的时候,向SYNC_ADDR地址写入1,这就是向同步寄存器写入1了,我在vga_update_screen函数中,并没有直接访问一个专门定义的同步寄存器的函数或者宏,而是直接判断vgactl_port_base[1]的内存.</p>
<p>所以直接裸着.</p>
<h2 id="全源码剖析">全源码剖析</h2>
<p>首先,需要了解的就是关于在am中对于地址的直接访问,nemu是如何模拟这一行为的.</p>
<p>关于游戏,或者说是对于一些IO接口的访问以及对于IO的实现,都是建立在对内存的控制上面,如果对于内存控制了解的足够深入,那么再去了解那些游戏运行机制,那么就更容易了.</p>
<p>引起思考就是在nemu的代码中,对于所有的硬件的初始化以及内存布局,都是严格的按照函数调用,层层解析的.</p>
<p>但是在am中对于某一个硬件的访问,访问设备寄存器是直接访问地址,这一不同现象.</p>
<p>在具体的阐释这里的原理是什么之前,我需要列出现象,代码逻辑.</p>
<p>nemu中的设备初始化以及内存布局.</p>
<p>init_device函数将进行一系列的设备初始化,并且按照了一定的顺序,首先就是这里的ioe_init函数.该函数在am中,这个行为属于硬件内部代码调用了驱动代码.</p>
<p>ioe_init函数调用了__am_gpu_init,__am_timer_init,__am_audio_init函数.在之前两个函数的实现当中,是没有内容的,更多的是一种测试代码.并没有内存的相关代码.这些也都是驱动代码</p>
<p>然后开始init_map函数的调用.该函数是硬件代码,</p>
<p>讲这里,就需要将整个设备的内存分配原理.</p>
<p>首先是使用malloc函数,给IO空间分配了一个大地址.这里的属于用驱动代码</p>
<h3 id="IO地址起始">IO地址起始</h3>
<p>使用了malloc,传入了IO_SPACE_MAX宏,malloc是根据hbrk指针来分配的.</p>
<p>而hbrk是维护整个堆的指针,一开始是根据heap.start值获得的.</p>
<p>heap是在是由_heap_start来获得的.而_heap_start变量是am的linker.ld链接脚本中定义的符号,用于0x1000对齐,也就是4KB内存对齐.</p>
<p>所以我们的堆一开始就是4KB对齐的.</p>
<p>这里随便另外讲一下_pmem_start也是类似的.</p>
<p>目前,依然没有讲关于这个_heap_start的值是多少,对应的内存地址是多少,也就是说,目前来说,这里分配的总IO地址是不知道的.</p>
<p>上述都是在&quot;驱动&quot;中的,然后,io_space就指向了IO总地址,p_space也指向了这里,但是p_space还有维护这个IO内部的内存地址</p>
<p>map的映射初始化完成了.然后开始初始化设备.第一个设备就是串口.</p>
<p>调用了init_serial函数,然后将调用new_space函数来申请了一个端口地址.</p>
<p>这里的new_space函数:<br>
通过p_space来维护IO空间,先是处理传入的size,内部的处理就是向下4KB大小对齐,也就是说,返回的空间最小也是4KB.(一个页大小)</p>
<p>然后p_space指向下一个地址(但是还是在IO空间内).</p>
<p>然后返回申请的首地址.</p>
<p>然后根据条件编译,这里讲地址映射,那么就是调用了add_mmio_map函数.</p>
<p>增加了一个设备,并且记录这个设备的地址映射信息.</p>
<p>同时,这个函数还需要传入设备名称name,设备地址addr,申请的端口地址space,space的大小len,以及回调函数callback.</p>
<p>这里的设备地址addr,就是理论设备地址.这里的space,就是实际的申请的地址,这个地址属于能申请到哪就到哪了.然后就是回调函数.这里的回调函数,就是更新端口信息(可以说是更新设备状态,刷新设备功能.)</p>
<p>这里的serial的回调就是查看写信息,然后直接嗲用serial_putc函数(内部就是调用了标准库的putch/putc函数,物理机),将信息输出.</p>
<p>一般回调函数,就是处理信息,然后处理申请的端口地址,将这里的数据处理掉.</p>
<p>add_mmio_map函数.根据传入的信息.处理space空间.</p>
<p>这些都是硬件实现.</p>
<p>该函数调用in_pmem函数检查,从这里可以看出,space的地址是大于0x80000000,所以在链接的时候,这里就被规定了一个高地址.</p>
<p>然后进行maps检查,这里nr_map记录实际的设备数量,NR_MAP记录最大设备数量.</p>
<p>这里防止和其他设备内存冲突,进行的检查.</p>
<p>然后在maps数据中注册设备,记录所有的信息,然后Log到记录中.</p>
<p>这里的addr数据,被记录到了low变量还总,len记录到了high变量中.其他的对应就可以了.</p>
<p>然后nr_map加1.</p>
<p>.</p>
<p>再次分析一下关于init_timer的分析.</p>
<p>同样,通过new_space申请空间,下一个页面大小,作为端口地址.</p>
<p>然后调用了add_mmio_map函数进行注册.</p>
<p>这里的回调函数就是对申请的空间进行操作.</p>
<p>不对理想设备地址进行操作.</p>
<p>进行了一系列的初始化.</p>
<p>然后开始了</p>
<p>monitor.c初始化完所有之后,一系列简单的调用之后,来到了cpuexec这里</p>
<p>每执行一条指令,就会调用device_update哈数.</p>
<p>这里的update函数,根据get_time函数(实际的标准时间),来调用vga_update_screen函数,进行屏幕的输出.这里就是关于vga的硬件实现以及其申请的空间信息的处理.</p>
<p>nemu的硬件实现就到这里就结束了.</p>
<p>然后来看一个软件方面,&quot;驱动&quot;是怎么利用硬件的.</p>
<p>从一个客户程序为例,rtc测试程序,需要调用io_read宏,传入的是AM_TIMER_UPTIME,然后引用了其us内部变量.</p>
<p>这里就从io_read宏开始是说起.</p>
<p>io_read宏之前分析过,最里面就是调用了lut函数指针数组.</p>
<p>这里的lut函数指针数组都是指向的函数,这里的函数(文档中的抽象寄存器),就是用于读取设备信息的.</p>
<p>最重要的来了.这里在am中是如何获取设备信息的.</p>
<p>这里以timer为例(实际上这里的写法是学习源框架代码写法的,有的地方就是直接访问内存,比如outb宏)</p>
<p>直接访问了RTC_ADDR指向的地址,这里的地址其实就是理想的设备地址,这里是直接访问了.</p>
<p>实际硬件是通过new_space函数申请的,由maps数组中的对应设备号中的space来表示的.</p>
<p>但是这里是直接访问了RTC_ADDR空间.</p>
<p>其实我们可以直接调用mmio_read函数,或者将地址传入paddr_read函数,都会调用到mmio_read函数,这里传入的地址,就是理想设备地址,这也是我们想要模拟的设备的好的处理方式.</p>
<p>我们传入理想地址,会有fetch_mmio_map函数根据理想地址,使用for循环索引maps中的单元,来获取对应的设备信息,以及申请的实际地址.</p>
<p>然后调用map_read/write函数</p>
<p>在这里,就是检查边界,然后根据addr(理想地址),来看看想要获取的设备的偏移地址.</p>
<p>然后调用host_read函数直接读数据.</p>
<p>这里的直接读,就是传入了map-&gt;space变量+offset,以及长度.</p>
<p>看来到了最后确实是根据实际的申请空间来读取数据的.</p>
<p>实际的host_read内部,其实是对应上了一开始申请的数组pmem.这是整个程序内存的源头,就是一个向物理机申请的数据.</p>
<p>从这里再往回看,那么_heap_start也是一个在数组中的一个地址值,是不为程序员所知道的.</p>
<p>am中的输出,调用了outb之类的,实际上也是直接向SERIAL_PORT地址写入数据.</p>
<p>这些设备的理想地址,都是定义在nemu.h中,之前在硬件中使用的理想地址是定义在nemu中的autoconf.h文件中.</p>
<p>在nemu.h文件中,定义了这些理想设备地址,并且给了一个_pmem_start变量.</p>
<p>还有一些关于PMEM*的宏,都是依赖与_pmem_start.</p>
<p>_pmem_start来源与linker.ld文件中,一个符号,这个符号在nemu.mk中被赋为了0x80000000.</p>
<p>不管是什么客户程序,在编译的时候,也是和运行时环境一块,和那些编写的库文件,库代码合在了一块,一起执行.</p>
<p>也就是说到了最后,运行时环境就是客户程序,客户程序也是运行环境.</p>
<p>要理解客户程序的运行,可以和理解运行时环境的运行放在一起.</p>
<p>这里在运行时环境的搭建过程中,有些访问都是很合乎情理,不管是内存访问还是逻辑计算(其实主要就是内存访问),都是可以通过层层的函数逻辑来演算.说到底,不如将nemu看成源代码,将输入看成一个包好的程序,这个程序就是运行时环境+客户程序.是一堆二进制码,nemu挨个去读二进制码,然后作出对应的动作,这里的逻辑都是通的.</p>
<p>甚至是写入的数据,然后对应的设备函数,也是被调用.</p>
<p>那么就通了,am中对于内存的直接访问,会被nemu捕获,对应到了其数组中.这里捕获的过程,主要就是编译的帮助,我们在链接的时候,所做的一些动作,可以更好的贴合程序的运行.</p>
<p>这样,就更体现出了nemu作为一个全系统的模拟器.所有的内存操作,到头都是对pmem数组的内部操作,包括nemu自己.而且,这里的mmio对与设备很好的访问函数,对于am是全部封装的.</p>
<p>am只能通过抽象寄存器,访问抽象地址.</p>
<h2 id="声卡与VGA">声卡与VGA</h2>
<h3 id="硬件">硬件</h3>
<p>使用enum来定义了几个状态寄存器,包括了freq,channels,samples,sbuf_size,init,count.硬件层面来使用audio_base来索引.</p>
<p>流缓存区是使用sbuf来申请了一个0x10000大小的空间.</p>
<p>关于handler函数,注册状态寄存器空间的时候,每一次的状态寄存器的访问,都会回调handler函数.</p>
<p>在handler里面实现了关于SDL库的初始化和OpenAudio函数,PauseAudio函数的调用.</p>
<p>这里每一次只能调用一次,所以加了一个static变量,用于实现只调用这个函数一次</p>
<p>关于回调函数的实现,用于将每一次SDL的申请大小len长度的userdata放入stream流中.</p>
<p>这里为了迎合测试函数,先是测试函数逻辑,便将每次传入定为4096.</p>
<h3 id="软件">软件</h3>
<p>宏定义了这些状态寄存器的理想地址.</p>
<p>init函数被取消了.为何?</p>
<p>init_device是用来初始化设备的,第一个条就是用来相对于CONFIG_TARGET_AM宏的ioe_init函数的条件编译.</p>
<p>在ioe_init函数中调用了__am_audio_init函数.</p>
<p>按理说在audio_init函数中访问状态寄存器赋予初始值,是需要先在map地址映射中注册信息的.</p>
<p>但是在此之前是没有注册地址信息的.所以我将其取消了</p>
<p>之前在取出audio的设备进行调试的时候,就因为添加了audio_init的实现,然后出现map中的check_bound错误.</p>
<p>config函数用来返回状态寄存器大小.ctrl用来写回到状态寄存器中的freq,channelds以及samplese.</p>
<p>这些没什么好说的.</p>
<p>主要是play函数,现在有多个版本的实现,最简单就是迎合测试函数的输入.这里先是一个while循环用于等待COUNT寄存器为0.</p>
<p>然后使用for循环将4096个字节传入sbuf流中.</p>
<p>在硬件那边,是用来等待COUNT寄存器不为0.</p>
<h3 id="问题">问题</h3>
<p>实现上来说都是正确的,播放时候也是正常,就是速度有点块.在第一天调试的时候,速度调成正常的了,后来就没调回来了:原因将下.</p>
<p>首先在实现声卡的时候,遇到了操作系统返回的错误:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*** buffer overflow detected*** terminate</span><br></pre></td></tr></table></figure>
<p>这是操作系统返回的错误,经过很久的调试,找到了原来是string中的strcpy函数实现有问题,这里的问题环境是在试下dtrace中出现的.</p>
<p>取消掉dtrace代码,一切恢复正常.</p>
<p>目前主要就是存在malloc的错误,比较深层次的错误.大概率是内存访问溢出.</p>
<p>错误复现1:</p>
<p>运行demo中的1,2等程序,将memset函数加上一个assert断言.</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//ui</span>nt32_t s_len = strlen(s);</span><br><span class="line"><span class="regexp">//</span>assert(n &lt;= s_len + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>即可出现bad错误,这个断言用于确定,置位的个数一定小于字符串的大小个数.</p>
<p>错误复现2:vga和audio设备都打开,然后运行vga程序正常.运行audio的test也正常.</p>
<p>草,怎么又正常了.</p>
<p>都打开之后,都能运行.行吧,反正之前是会出现这个错误2:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">malloc</span><span class="params">()</span></span>: corrupted <span class="attribute">top</span> size</span><br></pre></td></tr></table></figure>
<p>vga的多个线程的反复摧毁和建立3:</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">src/device/io/mmio.c:</span><span class="number">51</span> add_mmio_map] Add mmio map &#x27;vmem&#x27; at [<span class="number">0</span>xa1000000, <span class="number">0</span>xa10752ff]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffeacf0640 (LWP <span class="number">48391</span>)]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffea4ef640 (LWP <span class="number">48392</span>)]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffe9cee640 (LWP <span class="number">48393</span>)]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffe94ed640 (LWP <span class="number">48394</span>)]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffe8cdc640 (LWP <span class="number">48395</span>)]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffd3fff640 (LWP <span class="number">48396</span>)]</span><br><span class="line">[<span class="keyword">Thread</span> <span class="number">0</span>x7fffd3fff640 (LWP <span class="number">48396</span>) exited]</span><br><span class="line">[<span class="keyword">Thread</span> <span class="number">0</span>x7fffe8cdc640 (LWP <span class="number">48395</span>) exited]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffe8cdc640 (LWP <span class="number">48397</span>)]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffd3fff640 (LWP <span class="number">48398</span>)]</span><br><span class="line">[<span class="keyword">Thread</span> <span class="number">0</span>x7fffd3fff640 (LWP <span class="number">48398</span>) exited]</span><br><span class="line">[<span class="keyword">Thread</span> <span class="number">0</span>x7fffe8cdc640 (LWP <span class="number">48397</span>) exited]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffe8cdc640 (LWP <span class="number">48399</span>)]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffd3fff640 (LWP <span class="number">48400</span>)]</span><br><span class="line">[<span class="keyword">Thread</span> <span class="number">0</span>x7fffd3fff640 (LWP <span class="number">48400</span>) exited]</span><br><span class="line">[<span class="keyword">Thread</span> <span class="number">0</span>x7fffe8cdc640 (LWP <span class="number">48399</span>) exited]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffe8cdc640 (LWP <span class="number">48401</span>)]</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">Thread</span> <span class="number">0</span>x7fffd3fff640 (LWP <span class="number">48402</span>)]</span><br></pre></td></tr></table></figure>
<p>使用gdb的tui调试出,在SDL_Init函数中,出现的这么多线程的反复创建和调用.<br>
XCB和Xlib库的线程问题4:</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[xcb] Unknown sequence <span class="built_in">number</span> <span class="keyword">while</span> appending request</span><br><span class="line">[xcb] You called XInitThreads, this <span class="keyword">is</span> <span class="keyword">not</span> your fault</span><br><span class="line">[xcb] Aborting, sorry <span class="keyword">about</span> <span class="keyword">that</span>.</span><br><span class="line">riscv32-nemu-interpreter: ../../src/xcb_io.c:<span class="number">157</span>: append_pending_request: Assertion !xcb_xlib_unknown_seq_number&#x27; failed.</span><br><span class="line">make[<span class="number">1</span>]: *** [/home/bruce/project-a/git-project/ysyx-workbench/nemu/scripts/native.mk:<span class="number">49</span>: <span class="built_in">run</span>] Aborted (core dumped)</span><br></pre></td></tr></table></figure>
<p>现在知道了.</p>
<p>在make menuconfig中打开内存的监视器,就会出现问题2.</p>
<h3 id="更好的实现">更好的实现</h3>
<p>源码被注释了,就在现在可用代码的下面,已经不想说啥了,检查了每一个循环和调用环境,但是运行的时候还是会出现访问0xa1210000地址.</p>
<p>关键是test中的整个大小也没那么大呀.</p>
<h3 id="nemu上运行nemu">nemu上运行nemu</h3>
<p>现在的问题就是,取消掉ftrace功能后,必须将am中的makefile中的-lelf编译选项取消掉.因为无法链接.</p>
<h3 id="SDL中的stream问题">SDL中的stream问题</h3>
<p>传入2048的samples以及以及AUDIO_S16SYS的format,传回来的stream尽然是2048大小的.</p>
<p>这是开了sanitizer后的检测到的.后来修改了传入大小,声音也确实更和谐了</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/cn/detailed-explanation-compilation-loading-execution/" data-toggle="tooltip" data-placement="top" title="用户程序的编译、加载及执行流程详解">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/cn/setup_process_and_printf/" data-toggle="tooltip" data-placement="top" title="启动过程汇编与printf的有趣想法">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. All the images used in the blog are my original works or AI works, if you want to take it,don't hesitate. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=外设功能函数/跟踪函数与机制分析&body=Hi,I found this website and thought you might like it https://000xiaoming.github.io/cn/device_function_and_mechanism/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <script src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Sun Sep 01 2024 12:00:00 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">目录</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%85%B3%E4%BA%8E%E6%88%91"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">关于我</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9%E5%88%86%E7%B1%BB"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">主要内容分类</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%81%94%E7%B3%BB%E6%88%91"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">联系我</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%97%B6%E9%92%9F"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">时钟</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%94%99%E8%AF%AF%E7%BC%98%E8%B5%B7"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">错误缘起</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%9C%89%E8%B6%A3%E7%9A%84io-read%E5%AE%8F"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">有趣的io_read宏</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#putch%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number"></span> <span class="toc-nav-text">putch函数实现</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%85%B3%E4%BA%8Enative%E5%92%8Cklib%E7%9A%84%E9%9A%94%E7%A6%BB"><span class="toc-nav-number"></span> <span class="toc-nav-text">关于native和klib的隔离</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#dtrace%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-nav-number"></span> <span class="toc-nav-text">dtrace实现原理</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%85%B3%E4%BA%8E%E9%94%AE%E7%9B%98%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number"></span> <span class="toc-nav-text">关于键盘实现</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%A4%9A%E4%B8%AA%E9%94%AE%E5%90%8C%E6%97%B6%E6%8C%89%E4%B8%8B"><span class="toc-nav-number"></span> <span class="toc-nav-text">多个键同时按下</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#VGA"><span class="toc-nav-number"></span> <span class="toc-nav-text">VGA</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%85%B3%E4%BA%8EAM-GPU-CONFIG%E6%8E%A7%E5%88%B6%E5%99%A8%E4%BF%A1%E6%81%AF"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">关于AM_GPU_CONFIG控制器信息</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%80%BB%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">总内存大小</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%85%B3%E4%BA%8EAM-GPU-FBDRAW%E5%B8%A7%E7%BC%93%E5%AD%98%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">关于AM_GPU_FBDRAW帧缓存控制器</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%9C%A8am%E4%B8%AD%E7%9A%84%E8%AE%BF%E5%AD%98"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">在am中的访存</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">映射原理</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%B1%8F%E5%B9%95%E5%A4%A7%E5%B0%8F%E5%AF%84%E5%AD%98%E5%99%A8%E5%92%8C%E5%90%8C%E6%AD%A5%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">屏幕大小寄存器和同步寄存器</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%A3%B8%E7%9D%80%E7%9A%84%E6%8A%BD%E8%B1%A1%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">裸着的抽象寄存器</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%85%A8%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="toc-nav-number"></span> <span class="toc-nav-text">全源码剖析</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#IO%E5%9C%B0%E5%9D%80%E8%B5%B7%E5%A7%8B"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">IO地址起始</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%A3%B0%E5%8D%A1%E4%B8%8EVGA"><span class="toc-nav-number"></span> <span class="toc-nav-text">声卡与VGA</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%A1%AC%E4%BB%B6"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">硬件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%BD%AF%E4%BB%B6"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">软件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">问题</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%9B%B4%E5%A5%BD%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">更好的实现</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#nemu%E4%B8%8A%E8%BF%90%E8%A1%8Cnemu"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">nemu上运行nemu</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#SDL%E4%B8%AD%E7%9A%84stream%E9%97%AE%E9%A2%98"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">SDL中的stream问题</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">特色标签</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#项目工程" title="项目工程">项目工程</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>链友</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://v-vincen.life/" target="_blank">V_Vincen</a>
          </li>
          
          <li>
            <a href="http://beantech.org" target="_blank">Bean Tech</a>
          </li>
          
          <li>
            <a href="http://huangxuan.me" target="_blank">Hux Blog</a>
          </li>
          
          <li>
            <a href="https://hexo.io/" target="_blank">Hexo</a>
          </li>
          
          <li>
            <a href="https://fe32.top/" target="_blank">Ethan.Tzy</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/000xiaoming">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Bruce Lee
          2025
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/jquery.min.js"></script>

  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/bootstrap.min.js"></script>

  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/hux-blog.min.js"></script>

  <!-- catalog -->
  <script async="true" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/catalog.js"></script>

  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/totop.js"></script>

  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/mouseclick.js"  content='西风烈,长空雁叫霜晨月,霜晨月,马蹄声碎,喇叭声咽,雄关漫道真如铁,而今迈步从头越,从头越,苍山如海,残阳如血' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033' ></script>
    <!-- Mouseclick -->
  

  

  




  <!-- CDN: jsdelivr start -->
  <script async="async" type="text/javascript">
    let imgsUrl = document.getElementsByTagName("img");
    let imgUrl = Array.from(imgsUrl);

    let jsdelivr = "https://cdn.jsdelivr.net/gh/";
    let gh = "000xiaoming";
    let ghPages = gh + ".github.io";
    let pagePath = "cn/device_function_and_mechanism/";
    let jsdelivrurl;
    if (pagePath.indexOf("index.html") != -1) {
      jsdelivrurl = jsdelivr + gh + "/" + ghPages;
    } else {
      jsdelivrurl = jsdelivr + gh + "/" + ghPages + "/" + pagePath;
    }
    imgUrl.forEach(item => {
      let oldUrl = item.getAttribute("src");
      let newUrl = oldUrl.replace(oldUrl, jsdelivrurl + oldUrl).replace("..", "");
      item.setAttribute("src", newUrl);
    });
  </script>
  <!-- CDN: jsdelivr end -->



  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://000xiaoming.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="搜索..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            
              imgUrl = 'https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io' + imgUrl;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
