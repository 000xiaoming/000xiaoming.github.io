<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <meta name="baidu-site-verification" content="codeva-OySZDT59RD" />
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-Y95F7Y9NT1"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-Y95F7Y9NT1');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?9b08ea589f23fb1f5e2be85b8ca26b60";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>


  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="v-vincen,v-vincen,livemylife,IT  blog,Blog"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/highlight.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/widget.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/rocket.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/signature.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/catalog.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/css/gitalk.css"/>
      <!-- gitalk end -->
    

  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://000xiaoming.github.io/cn/RISCV各类冒险问题/">
  <title>
    
      RISCV停顿与非停顿冒险/x0寄存器的数据冒险处理陷阱/寄存器同周期读写的解决方法/解决EX/MEM冒险 - I&#39;m Bruce Lee
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">经年治世</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">首页</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              关于
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archives/">
              
              归档
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              分类
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              标签
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>搜索</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <!-- CDN: jsdelivr start -->
  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/lml_bg1.png');
      --intro-header-background-image-url-page: url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io//img/header_img/lml_bg1.png');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/lml_bg1.png');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io//img/header_img/lml_bg1.png');
    }
    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/img/header_img/lml_bg1.png'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/vincent-white.png');
      }
    
  </style>
  <!-- CDN: jsdelivr end -->





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#RISC-V问题和解决方案以及现象" title="RISC-V问题和解决方案以及现象">RISC-V问题和解决方案以及现象</a>
              
            </div>
            <h1>RISCV停顿与非停顿冒险/x0寄存器的数据冒险处理陷阱/寄存器同周期读写的解决方法/解决EX/MEM冒险</h1>
            <h2 class="subheading">RISC-V</h2>
            <span class="meta">
              Posted by Bruce Lee on
              2024-01-26
            </span>


            
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h2 id="结构冒险的避免">结构冒险的避免</h2>
<p>这种硬件结构上的缺陷,导致流水线上的不同指令执行,对于数据通路单元的使用产生了矛盾.<br>
加入处理器只有一种存储器,将指令存储器和数据存储器合并.<br>
如果第一条指令的第4步骤是读数据,需要读存储器,第4条指令需要取指令,读存储器.这就是在硬件使用上的冲突.<br>
所以在设计流水线时,从单周期处理器指令入手,避免在一条指令中使用重复的数据通路单元.避免不同指令的工序出现颠倒,如果出现工序减少,但是执行顺序是一致的,这也是正确的,但是如果顺序不一致,我们应该复制数据通路单元,避免在流水线设计中,出现结构冒险.</p>
<h2 id="数据冒险问题">数据冒险问题</h2>
<p>相比于结构冒险,数据冒险是对于数据的使用上,出现了矛盾.<br>
如果单周期处理器的每条指令都看作是相对独立的任务,任务之间没有依赖关系.<br>
那么不会出现在数据使用上的矛盾.<br>
但是程序中经常有任务之间相互依赖数据的代码:</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">1 </span>  add x19, x0, x1</span><br><span class="line"><span class="symbol">2 </span>  sub x2, x19, x3</span><br></pre></td></tr></table></figure>
<p>2指令中的x19的值在逻辑上需要add指令更新,2指令在执行读取寄存器/译码指令时,需要访问x19,但是此时x19并没有更新,x19在1指令的5阶段更新.<br>
如果直接这样设计处理器,我们sub中x19的值就是旧值,计算出现差错.<br>
一种简单的方法是等待,x19的值没有更新,我们等待1指令执行,一直到第5阶段执行完毕.<br>
但是这会导致另一种问题:如果2指令中的读取寄存器/译码指令工序停止了,其他正在处理其他指令的工序还会工作吗?</p>
<h3 id="流水线工序传递问题">流水线工序传递问题</h3>
<p>流水线上的每一个工序在传递时,需要全部工序完成后,同时传递.这一特点也导致了每一个工序的规定时间是最慢工序的执行时间.当出现数据冒险,一个工序的材料没有准备好,该工序无法继续完成逻辑上正确的工作,其所依赖的数据是前面还在流水线上的指令的工序结果.如果想等待前指令完成,除非那正好是前指令的最后一道工序,否则,我们永远无法获得正确的数据.那么就只能清理流水线.<br>
这里的数据冒险特点就是:如果前指令的某道工序的结果需要放在寄存器中,便于后指令的访问,那么在出现前指令数据结果出来后,还没有放置寄存器中,后指令就需要访问寄存器读取最新的结果.(目前阶段在时间上晚于源阶段)<br>
解决方法就是,前指令的数据结果,不再寻求一定要放置寄存器中,因为这会导致流水线停顿.而是直接添加硬件逻辑关系,将其结果送到后指令的工序中.</p>
<h3 id="几种可处理的数据冒险">几种可处理的数据冒险</h3>
<h4 id="非停顿RAW冒险">非停顿RAW冒险</h4>
<p>第一种是上述那样的数据冒险,后指令需要的数据已经在前指令中计算出来,但是还没有将数据放在目标寄存器中,我们可以采用前递技术来处理.<br>
这类就是当一条指令要读取的寄存器,是上一条指令的写回目标寄存器,即两条指令访问同一个寄存器,并且存在“读”在“写”的后面时,这两条指令之间就存在RAW相关。<br>
通常只需要前递即可,不会产生流水线停顿</p>
<h4 id="停顿load-use数据冒险">停顿load-use数据冒险</h4>
<p>第二种,就是如果后指令需要的数据还没有计算出来,这分为两种情况.<br>
第一种是:正在执行的后指令所需要的数据,前指令也正在计算该数据,那么我们可以在该周期内,后指令工序停止执行,等待前指令工序执行完毕,然后传递过来,再执行,等后指令执行完毕,同时移动流水线.术语是:载入-使用型数据冒险<br>
第二种是:正在执行的后指令所需要的数据,前指令还没有也没正在计算,这会导致流水线停顿.</p>
<p>通常读取寄存器的时候,数据还没有从数据寄存器读出,一般相差两个时钟,所以需要停顿和前递.</p>
<h2 id="普通情况下PC移到下一个地址-发生在什么时候">普通情况下PC移到下一个地址,发生在什么时候.</h2>
<p>在很多专业书籍里面都提及到pc自增的知识,一般描述都是在pc指向的地址取出指令,然后pc自动默认移向下一条指令.<br>
这个移动发生在计算阶段:第一阶段需要取出指令,然后进入译码/读取寄存器阶段,同时,pc默认的递增值也在计算.但是这个时候控制器也在计算控制信号,当这个阶段完成后,进入alu计算阶段时,pc的值才被更新.</p>
<h2 id="重述流水线停顿与流水线指令流">重述流水线停顿与流水线指令流</h2>
<p>单周期处理器指令,以分割出多道工序加工.这里以&quot;指令&quot;指代单周期处理器指令,以&quot;工序&quot;指代流水线处理器指令.<br>
指令内部的工序,无法停顿,如果出现差错,这就是一个失败的处理器.<br>
指令之间可以出现停顿,这种情况包括上述讲的指令结果依赖,前递,旁路一样.<br>
设计流水线并且想象流水线工作场景,更好的方式是以指令数据流移动的方式,而不是以工序硬件移动的方式.</p>
<h2 id="解决控制冒险的简单思路">解决控制冒险的简单思路</h2>
<p>当出现条件分支时,条件分支指令还没有计算出下一条指令地址时,就已经有未来指令在流水线上执行了,为了避免这种情况,最简单的就是停止后续指令流水线的载入,等待条件分支指令的结果.在整点程序中,条件分支指令数量大,性能大幅度减低.有几个优化方案.<br>
首先应该想到最简单的优化就是加速条件分支指令的执行,争取在第二阶段就进行译码/计算得出结果,这样流水线只需要停顿一个周期就可以,但是往往有些条件分支指令的执行,需要流水线停顿不止一个周期.</p>
<p>第二个就是想到,为了避免流水线停顿,造成的其他工序闲置,减低性能,我们就在这下一条指令加载流水之前,加载一些安全指令.<br>
这就是MIPS指令系统所做的.在添加一条安全指令在分支条件指令后面,这个往往是编译器所做的安全指令排序,对汇编程序员不可见.在执行分支条件指令时,同时也在执行安全指令,总体上计算机性能并没有减低,但是程序中能够被认为安全的指令可能较少,所以有时候也会造成性能减低.(不管条件分支是否跳转,都会执行,并且不被位置和时间的不同而造成结果不同的指令)</p>
<p>第三个就是分支预测,根据大量的观察来区分不同的分支指令的跳转概率,来假定接下来一定是这个地址的指令,进行加载执行.</p>
<h2 id="流水线寄存器实现工序隔离以及一些逻辑变换">流水线寄存器实现工序隔离以及一些逻辑变换</h2>
<p>在原来单周期数据通路中,要想做到流水线那样的工序加工,并且为了避免某一个工序加工完成之后盲目的传递到下一道工序,我们需要将工序之间隔离,使用寄存器来存储数据,隔离工序.<br>
在每一个工序之间加一个寄存器&quot;墙&quot;,用来存储每一个工序目前的数据.<br>
同一时间段,每一个阶段处理的对象都属于不同的指令,所以任何包含该指令的信息需要随着自己在流水线寄存器中传递.没有的寄存器负责记录你.因此某些使用与单周期数据通路的控制器和控制信号连接都需要作出适当的调整.</p>
<h2 id="寄存器同周期读写的解决方法">寄存器同周期读写的解决方法</h2>
<p>我们在设计时,总是架设寄存器在任何时候都是可读的,但是不是在任何时候都是可写的.<br>
所以我们的寄存器需要一个写信号,但是在数据存储器里,我们不仅需要写信号,也需要读信号.<br>
如果在同周期内,写信号来临,这时候也有别的数据通路单元来读取,我们应该怎么处理这种数据竞争呢?<br>
在寄存器实现内部,实现这两种动作的区分.<br>
1.在上升沿来临时,使用写动作,在周期的后半部分(下降沿来临),使用读动作.<br>
2.使用前递技术,也就是当读取动作来临的时候,同时写信号也来临,我们直接将写入数据前递到输出端口.</p>
<h2 id="将发生数据冒险的数据直接传递到ALU输入">将发生数据冒险的数据直接传递到ALU输入</h2>
<p>我们所有的指令,在执行计算阶段时,需要的输入是之前指令(该指令也还在流水线上)的写入寄存器的值时,我们直接将哪个数据前递到ALU输入前.<br>
这个也是解决其他冒险的通用方法:在需要的时候处理</p>
<h2 id="特殊的x0寄存器的数据冒险处理陷阱">特殊的x0寄存器的数据冒险处理陷阱</h2>
<p>我们都知道,在一条指令需要前一条指令的计算结果时,我们可以在前一条指令的alu输出后,直接将EX/MEM寄存器的值前递到EX的输入端口.这是普通冒险的处理方式.<br>
但是这种普通冒险中有一种特殊的情况:<br>
当前者的目的寄存器是x0,后者的源寄存器也是x0时.<br>
正确逻辑:后者的源寄存器采用x0,是想利用x0的0值.<br>
实际逻辑:后者使用x0时,被识别为需要前递,然后将前者的中间计算结果直接传递的后者的EX阶段输入,这个中间计算结果按理说在被传入x0寄存器后消失,但是我们并没有直接使用x0的结果,而是在其还在EX/MEM阶段时,就直接使用了.<br>
所以在设计前递控制单元逻辑时,需要警惕,前者的RD不能是x0,否则不产生前递.</p>
<h2 id="设计逻辑控制时应该在产生数据端做逻辑输出还是在应用数据端做逻辑采纳">设计逻辑控制时应该在产生数据端做逻辑输出还是在应用数据端做逻辑采纳</h2>
<p>我们为了保持一种简单设计,其实是将产生数据的单元直接广播出去,需要对应单元的数据通路单元来根据实际情况来采纳.<br>
不仅是总线是这样设计的,在前递技术设计时,尤其是ALU计算阶段的数据输入,多选器都是放置在ALU端口前,做控制.</p>
<h2 id="ALU第二数据输入的控制和前递数据控制的安排逻辑">ALU第二数据输入的控制和前递数据控制的安排逻辑</h2>
<p>在单周期数据通路中,ALU使用了一个二选一多选器(a多选器)来选择第二个输入是来自寄存器堆还是来自立即数生成器.<br>
在添加了流水线和前递技术后,我们在ALU的每一个输入端口都添加了三选一多选器(b多选器)(1.选择原输入.2.选择EX/MEM前递.3.选择MEM/WB前递),这两个多选器如何安置呢?<br>
首先的想法就是将a安排在b的前面:当指令选择立即数输入时,a会选择立即数,b会选择原输入.当指令选择寄存器时,a会选择寄存器,b会会根据数据冒险来调整选择.这都是合适的.<br>
尝试逻辑思考一下b安排在a的前面:当指令选择立即数输入是,b会选择原输入,a会选择立即数输入.当指令选择寄存器时,b会根据数据冒险来调整选择,a会选择寄存器.这也都是合适的.<br>
为何专家说要将b安排在a的前面呢:分析一下每一个多选器的本质,b的本质就是寄存器输入,不管选择谁,本质就是寄存器中的值,都是寄存器堆里的数据,只不过有些输入的值,还没来得及放入寄存器中.a的输入一个是寄存器,一个是立即数.<br>
这样就清晰了,b确实应该安排在a的前面.</p>
<h2 id="EX冒险与MEM冒险冲突">EX冒险与MEM冒险冲突</h2>
<p>当出现一个冒险时,我们已经有了解决方案,但是当两个冒险同时出现时,应该选择哪一个前递数据呢?</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add</span> <span class="keyword">x</span><span class="number">1</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">1</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">2</span></span><br><span class="line"><span class="keyword">add</span> <span class="keyword">x</span><span class="number">1</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">1</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">3</span></span><br><span class="line"><span class="keyword">add</span> <span class="keyword">x</span><span class="number">1</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">1</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>第2条指令出现了EX冒险,因为前递单元检测到其依赖于上一条指令x1寄存器.<br>
第3条指令出现了EX冒险,MEM冒险,因为前递单元检测到其依赖上一条指令的x1寄存器,这是发生在EX阶段,检测ID/EX寄存器和EX/MEM寄存器得出的.同时呢,也检测到了其依赖上上一条指令,这是发生在MEM阶段,检测ID/EX寄存器和MEM/WB寄存器得出的.<br>
显然我们需要区分这两种情况,根据计算逻辑,我们显然需要选择EX冒险的前递,并且忽略MEM冒险的前递.<br>
有一个EX冒险和MEM冒险的简单的设计逻辑:</p>
<h3 id="解决EX-MEM冒险冲突的设计逻辑">解决EX/MEM冒险冲突的设计逻辑</h3>
<p>当发生EX冒险时,任何情况下我们都是直接选择EX/MEM寄存器的前递,所以可以很直接的写出逻辑:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A input</span></span><br><span class="line"><span class="keyword">if</span> EX/MEM.RegWrite</span><br><span class="line">and EX/MEM<span class="selector-class">.RegisterRd</span> == ID/EXE.RegisterRs1</span><br><span class="line">and EX/MEM<span class="selector-class">.RegisterRd</span> != <span class="number">0</span> <span class="comment">//避免x0陷阱</span></span><br><span class="line">ForwardA = <span class="number">10</span></span><br><span class="line"><span class="comment">//B input</span></span><br><span class="line"><span class="keyword">if</span> EX/MEM.RegWrite</span><br><span class="line">and EX/MEM<span class="selector-class">.RegisterRd</span> == ID/EXE.RegisterRs2</span><br><span class="line">and EX/MEM<span class="selector-class">.RegisterRd</span> != <span class="number">0</span> <span class="comment">//避免x0陷阱</span></span><br><span class="line">ForwardB = <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>当出现MEM冒险时,我需要甄别一下,是否真的需要EX/MEM前递.<br>
于是有了该MEM冒险逻辑:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A input</span></span><br><span class="line"><span class="keyword">if</span> MEM/WB.RegWrite</span><br><span class="line">and MEM/WB<span class="selector-class">.RegisterRd</span> == ID/EXRegisterRs1</span><br><span class="line">and MEM/WB<span class="selector-class">.RegisterRd</span> != <span class="number">0</span></span><br><span class="line">and not (EX/MEM<span class="selector-class">.RegWrite</span> and (EX/MEM<span class="selector-class">.RegisterRd</span> == ID/EX.RegisterRs1) and (EX/MEM<span class="selector-class">.RegisterRd</span> != <span class="number">0</span>))</span><br><span class="line">Forward = <span class="number">01</span></span><br><span class="line"><span class="comment">//B input</span></span><br><span class="line"><span class="keyword">if</span> MEM/WB.RegWrite</span><br><span class="line">and MEM/WB<span class="selector-class">.RegisterRd</span> == ID/EXRegisterRs2</span><br><span class="line">and MEM/WB<span class="selector-class">.RegisterRd</span> != <span class="number">0</span> <span class="comment">//避免x0陷阱</span></span><br><span class="line">and not (EX/MEM<span class="selector-class">.RegWrite</span> and (EX/MEM<span class="selector-class">.RegisterRd</span> == ID/EX.RegisterRd2) and (EX/MEM<span class="selector-class">.RegisterRd</span> != <span class="number">0</span>)) <span class="comment">//避免与EX冒险冲突</span></span><br><span class="line">Forward = <span class="number">01</span></span><br></pre></td></tr></table></figure>

        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/cn/RISCV不同阶段冒险问题和分支/" data-toggle="tooltip" data-placement="top" title="RISCV不同阶段前递问题/load-use冒险的停顿技术/优化控制冒险发生时浪费的时钟周期问题分析/ID计算加速的专用前递通路问题/PC清理-预测加速问题/流水线清理问题">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/cn/RISCV运算中间结果系列问题/" data-toggle="tooltip" data-placement="top" title="RISCV舍入问题和中间结果存储问题/浮点并行加速的不稳定性问题以及传统并行算法研究步骤">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. All the images used in the blog are my original works or AI works, if you want to take it,don't hesitate. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=RISCV停顿与非停顿冒险/x0寄存器的数据冒险处理陷阱/寄存器同周期读写的解决方法/解决EX/MEM冒险&body=Hi,I found this website and thought you might like it https://000xiaoming.github.io/cn/RISCV各类冒险问题/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <script src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Fri Jan 26 2024 12:00:00 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">目录</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%BB%93%E6%9E%84%E5%86%92%E9%99%A9%E7%9A%84%E9%81%BF%E5%85%8D"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">结构冒险的避免</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%95%B0%E6%8D%AE%E5%86%92%E9%99%A9%E9%97%AE%E9%A2%98"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">数据冒险问题</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%B7%A5%E5%BA%8F%E4%BC%A0%E9%80%92%E9%97%AE%E9%A2%98"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">流水线工序传递问题</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%87%A0%E7%A7%8D%E5%8F%AF%E5%A4%84%E7%90%86%E7%9A%84%E6%95%B0%E6%8D%AE%E5%86%92%E9%99%A9"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">几种可处理的数据冒险</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%9D%9E%E5%81%9C%E9%A1%BFRAW%E5%86%92%E9%99%A9"><span class="toc-nav-number">2.2.1.</span> <span class="toc-nav-text">非停顿RAW冒险</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%81%9C%E9%A1%BFload-use%E6%95%B0%E6%8D%AE%E5%86%92%E9%99%A9"><span class="toc-nav-number">2.2.2.</span> <span class="toc-nav-text">停顿load-use数据冒险</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%99%AE%E9%80%9A%E6%83%85%E5%86%B5%E4%B8%8BPC%E7%A7%BB%E5%88%B0%E4%B8%8B%E4%B8%80%E4%B8%AA%E5%9C%B0%E5%9D%80-%E5%8F%91%E7%94%9F%E5%9C%A8%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">普通情况下PC移到下一个地址,发生在什么时候.</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E9%87%8D%E8%BF%B0%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%81%9C%E9%A1%BF%E4%B8%8E%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%8C%87%E4%BB%A4%E6%B5%81"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">重述流水线停顿与流水线指令流</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3%E6%8E%A7%E5%88%B6%E5%86%92%E9%99%A9%E7%9A%84%E7%AE%80%E5%8D%95%E6%80%9D%E8%B7%AF"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">解决控制冒险的简单思路</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%AF%84%E5%AD%98%E5%99%A8%E5%AE%9E%E7%8E%B0%E5%B7%A5%E5%BA%8F%E9%9A%94%E7%A6%BB%E4%BB%A5%E5%8F%8A%E4%B8%80%E4%BA%9B%E9%80%BB%E8%BE%91%E5%8F%98%E6%8D%A2"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">流水线寄存器实现工序隔离以及一些逻辑变换</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E5%90%8C%E5%91%A8%E6%9C%9F%E8%AF%BB%E5%86%99%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">寄存器同周期读写的解决方法</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%B0%86%E5%8F%91%E7%94%9F%E6%95%B0%E6%8D%AE%E5%86%92%E9%99%A9%E7%9A%84%E6%95%B0%E6%8D%AE%E7%9B%B4%E6%8E%A5%E4%BC%A0%E9%80%92%E5%88%B0ALU%E8%BE%93%E5%85%A5"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">将发生数据冒险的数据直接传递到ALU输入</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%89%B9%E6%AE%8A%E7%9A%84x0%E5%AF%84%E5%AD%98%E5%99%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%86%92%E9%99%A9%E5%A4%84%E7%90%86%E9%99%B7%E9%98%B1"><span class="toc-nav-number">9.</span> <span class="toc-nav-text">特殊的x0寄存器的数据冒险处理陷阱</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E8%AE%BE%E8%AE%A1%E9%80%BB%E8%BE%91%E6%8E%A7%E5%88%B6%E6%97%B6%E5%BA%94%E8%AF%A5%E5%9C%A8%E4%BA%A7%E7%94%9F%E6%95%B0%E6%8D%AE%E7%AB%AF%E5%81%9A%E9%80%BB%E8%BE%91%E8%BE%93%E5%87%BA%E8%BF%98%E6%98%AF%E5%9C%A8%E5%BA%94%E7%94%A8%E6%95%B0%E6%8D%AE%E7%AB%AF%E5%81%9A%E9%80%BB%E8%BE%91%E9%87%87%E7%BA%B3"><span class="toc-nav-number">10.</span> <span class="toc-nav-text">设计逻辑控制时应该在产生数据端做逻辑输出还是在应用数据端做逻辑采纳</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#ALU%E7%AC%AC%E4%BA%8C%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E7%9A%84%E6%8E%A7%E5%88%B6%E5%92%8C%E5%89%8D%E9%80%92%E6%95%B0%E6%8D%AE%E6%8E%A7%E5%88%B6%E7%9A%84%E5%AE%89%E6%8E%92%E9%80%BB%E8%BE%91"><span class="toc-nav-number">11.</span> <span class="toc-nav-text">ALU第二数据输入的控制和前递数据控制的安排逻辑</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#EX%E5%86%92%E9%99%A9%E4%B8%8EMEM%E5%86%92%E9%99%A9%E5%86%B2%E7%AA%81"><span class="toc-nav-number">12.</span> <span class="toc-nav-text">EX冒险与MEM冒险冲突</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3EX-MEM%E5%86%92%E9%99%A9%E5%86%B2%E7%AA%81%E7%9A%84%E8%AE%BE%E8%AE%A1%E9%80%BB%E8%BE%91"><span class="toc-nav-number">12.1.</span> <span class="toc-nav-text">解决EX&#x2F;MEM冒险冲突的设计逻辑</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">特色标签</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#RISC-V问题和解决方案以及现象" title="RISC-V问题和解决方案以及现象">RISC-V问题和解决方案以及现象</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>链友</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://v-vincen.life/" target="_blank">V_Vincen</a>
          </li>
          
          <li>
            <a href="http://beantech.org" target="_blank">Bean Tech</a>
          </li>
          
          <li>
            <a href="http://huangxuan.me" target="_blank">Hux Blog</a>
          </li>
          
          <li>
            <a href="https://hexo.io/" target="_blank">Hexo</a>
          </li>
          
          <li>
            <a href="https://fe32.top/" target="_blank">Ethan.Tzy</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/000xiaoming">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Bruce Lee
          2024
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/jquery.min.js"></script>

  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/bootstrap.min.js"></script>

  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/hux-blog.min.js"></script>

  <!-- catalog -->
  <script async="true" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/catalog.js"></script>

  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/totop.js"></script>

  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/mouseclick.js"  content='西风烈,长空雁叫霜晨月,霜晨月,马蹄声碎,喇叭声咽,雄关漫道真如铁,而今迈步从头越,从头越,苍山如海,残阳如血' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033' ></script>
    <!-- Mouseclick -->
  

  

  




  <!-- CDN: jsdelivr start -->
  <script async="async" type="text/javascript">
    let imgsUrl = document.getElementsByTagName("img");
    let imgUrl = Array.from(imgsUrl);

    let jsdelivr = "https://cdn.jsdelivr.net/gh/";
    let gh = "000xiaoming";
    let ghPages = gh + ".github.io";
    let pagePath = "cn/RISCV各类冒险问题/";
    let jsdelivrurl;
    if (pagePath.indexOf("index.html") != -1) {
      jsdelivrurl = jsdelivr + gh + "/" + ghPages;
    } else {
      jsdelivrurl = jsdelivr + gh + "/" + ghPages + "/" + pagePath;
    }
    imgUrl.forEach(item => {
      let oldUrl = item.getAttribute("src");
      let newUrl = oldUrl.replace(oldUrl, jsdelivrurl + oldUrl).replace("..", "");
      item.setAttribute("src", newUrl);
    });
  </script>
  <!-- CDN: jsdelivr end -->



  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://000xiaoming.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="搜索..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            
              imgUrl = 'https://cdn.jsdelivr.net/gh/000xiaoming/000xiaoming.github.io' + imgUrl;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
